# 采用的主要技术、遇到的难点和解决方法

## 一、采用的主要技术

### 1.1 编程语言与开发工具
- **C/C++语言**：实现系统核心逻辑，使用结构体管理复杂数据
- **EasyX图形库**：实现图形化用户界面，提供良好的交互体验
- **Visual Studio 2022**：集成开发环境，提供调试和编译支持

### 1.2 核心技术

#### （1）数据结构设计
- 使用结构体封装用户、物品、交易、评价等实体
- 采用数组存储数据，支持快速遍历和访问
- 设计枚举类型管理状态和等级

#### （2）图形界面技术
- **双缓冲绘制**：使用`BeginBatchDraw()`和`EndBatchDraw()`避免屏幕闪烁
- **事件驱动编程**：通过`ExMessage`处理鼠标和键盘事件
- **模块化界面**：每个界面独立绘制和事件处理函数

#### （3）输入管理机制
- **双缓冲区设计**：通用缓冲区+专用缓冲区，实现多输入框管理
- **焦点切换机制**：通过`g_activeInputBox`标识当前激活输入框
- **数据同步**：焦点切换时自动保存和加载数据

#### （4）数据持久化
- **文本文件存储**：使用`.txt`文件，数据以逗号分隔，便于读取和解析
- **文件I/O操作**：`fopen`、`fprintf`、`fscanf`实现数据读写
- **增量保存优化**：新增数据时使用追加模式，提高效率

#### （5）算法应用
- **线性查找**：用户登录验证、物品查找
- **字符串匹配**：关键词搜索（`strstr`函数）
- **加权评分算法**：信誉分数计算
- **选择排序**：信誉排行榜

---

## 二、遇到的主要难点及解决方法

### 难点1：中文字符显示乱码

**问题描述**：
界面中文文字显示为乱码或方框，影响用户体验。

**原因分析**：
- 项目字符集设置为Unicode，而EasyX默认使用多字节字符集
- 源文件编码与运行时编码不一致

**解决方法**：
1. 在项目属性中设置字符集为"使用多字节字符集"
2. 确保源文件保存为GB2312编码
3. 使用`outtextxy`而非`outtextwxy`输出文本

**效果**：中文正常显示，界面清晰可读

---

### 难点2：多输入框焦点管理混乱

**问题描述**：
系统有多个输入框（用户名、密码、物品信息等），点击切换时输入内容出现在错误的输入框，或者数据丢失。

**原因分析**：
- 所有输入框共享同一个键盘事件处理函数
- 焦点切换时未正确保存和加载数据
- 缺少统一的输入管理机制

**解决方法**：
1. 设计双缓冲区机制：
   - 通用缓冲区`g_inputBuffer`：接收键盘输入
   - 专用缓冲区：每个输入框独立存储（如`g_loginUsernameBuffer`）
   
2. 实现焦点管理：
   ```cpp
   // 保存当前输入框内容
   void saveInputBufferContent() {
       switch (g_activeInputBox) {
           case 1: strcpy(g_add_itemNameBuffer, g_inputBuffer); break;
           case 11: strcpy(g_loginUsernameBuffer, g_inputBuffer); break;
           // ...
       }
   }
   
   // 加载新输入框内容
   void loadInputBufferContent(int targetBox) {
       switch (targetBox) {
           case 1: strcpy(g_inputBuffer, g_add_itemNameBuffer); break;
           case 11: strcpy(g_inputBuffer, g_loginUsernameBuffer); break;
           // ...
       }
   }
   ```

3. 焦点切换流程：
   - 保存旧焦点数据 → 切换焦点ID → 加载新焦点数据

**效果**：输入框切换流畅，数据不丢失

---

### 难点3：信誉分数计算不准确

**问题描述**：
用户信誉分数与预期不符，有时出现负数，有时评分加成不正确。

**原因分析**：
- 评分规则设计不合理，边界条件处理不当
- 未考虑分数可能为负的情况
- 交易状态判断逻辑错误

**解决方法**：
1. 重新设计评分规则：
   - 完成交易：+10分/笔
   - 取消交易：-5分/笔
   - 评分加成：根据平均评分分段加减分

2. 添加边界检查：
   ```cpp
   // 确保分数非负
   if (score < 0) {
       score = 0;
   }
   ```

3. 完善计算逻辑：
   ```cpp
   // 先统计交易，再计算评分加成
   for (交易) { 累加分数 }
   avgRating = calculateAverageRating();
   if (avgRating >= 4.5) score += 50;
   // ...
   ```

4. 编写单元测试验证：
   - 测试新用户（0分）
   - 测试优秀用户（高分）
   - 测试差评用户（低分）

**效果**：信誉分数计算准确，符合预期

---

### 难点4：删除操作导致数组越界

**问题描述**：
删除物品或用户后，程序崩溃或显示异常数据。

**原因分析**：
- 删除元素后未更新数组计数
- 访问数组时未检查索引范围
- 滚动偏移量未随删除操作调整

**解决方法**：
1. 完善删除逻辑：
   ```cpp
   void deleteItemById(int id) {
       // 查找索引
       int foundIndex = -1;
       for (int i = 0; i < g_itemCount; i++) {
           if (g_items[i].id == id) {
               foundIndex = i;
               break;
           }
       }
       
       if (foundIndex == -1) return;
       
       // 移动后续元素
       for (int i = foundIndex; i < g_itemCount - 1; i++) {
           g_items[i] = g_items[i + 1];
       }
       
       // 更新计数（关键）
       g_itemCount--;
   }
   ```

2. 添加边界检查：
   ```cpp
   // 访问数组前检查
   if (index >= 0 && index < g_itemCount) {
       // 安全访问
   }
   ```

3. 调整滚动偏移量：
   ```cpp
   // 删除后检查偏移量是否越界
   if (g_itemListScrollOffset >= g_itemCount - ITEMS_PER_PAGE) {
       g_itemListScrollOffset = max(0, g_itemCount - ITEMS_PER_PAGE);
   }
   ```

**效果**：删除操作稳定，无崩溃现象

---

### 难点5：数据保存失败导致数据丢失

**问题描述**：
程序退出后，新增或修改的数据丢失，文件内容为空或损坏。

**原因分析**：
- 文件路径错误（使用了绝对路径）
- 文件打开失败但未检查
- 写入过程中程序崩溃导致文件损坏

**解决方法**：
1. 使用相对路径：
   ```cpp
   // 错误：绝对路径
   FILE* fp = fopen("C:\\Users\\...\\items.txt", "w");
   
   // 正确：相对路径
   FILE* fp = fopen("items.txt", "w");
   ```

2. 添加错误检查：
   ```cpp
   FILE* fp = fopen("items.txt", "w");
   if (fp == NULL) {
       printf("错误：无法打开文件！\n");
       return -1;
   }
   ```

3. 实现原子性保存（可选）：
   ```cpp
   // 先写入临时文件
   FILE* fp = fopen("items.txt.tmp", "w");
   // 写入数据...
   fclose(fp);
   
   // 重命名（原子操作）
   remove("items.txt");
   rename("items.txt.tmp", "items.txt");
   ```

4. 关键操作后立即保存：
   ```cpp
   // 发布物品后立即保存
   g_items[g_itemCount++] = newItem;
   saveItemsToFile("items.txt");  // 立即保存
   ```

**效果**：数据可靠保存，程序重启后数据完整

---

## 三、技术总结

通过本项目的开发，成功应用了以下技术并解决了相应难点：

1. **图形界面开发**：掌握了EasyX库的使用，实现了友好的用户界面
2. **数据结构设计**：合理设计结构体和数组，高效管理复杂数据
3. **输入管理**：创新性地设计了双缓冲区机制，解决了多输入框管理难题
4. **算法应用**：实践了查找、排序、字符串匹配等经典算法
5. **数据持久化**：实现了可靠的文件读写，保证数据安全

这些技术的应用和难点的解决，不仅完成了系统功能，更重要的是培养了分析问题、解决问题的能力，为今后的软件开发打下了坚实基础。
